name: Update OpenAPI Specs

on:
  workflow_dispatch:
  schedule:
    # Run weekly on Monday at 9:00 AM UTC
    - cron: '0 9 * * 1'

permissions:
  contents: write
  pull-requests: write

jobs:
  update-openapi-specs:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
      
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: |
            9.0.x
            10.0.x-preview
      
      - name: Restore tools
        run: dotnet tool restore
        working-directory: .
      
      - name: Build V1 API (generates OpenAPI specs)
        run: dotnet build src/XtremeIdiots.Portal.Repository.Api.V1/XtremeIdiots.Portal.Repository.Api.V1.csproj --configuration Debug
      
      - name: Build V2 API (generates OpenAPI specs)
        run: dotnet build src/XtremeIdiots.Portal.Repository.Api.V2/XtremeIdiots.Portal.Repository.Api.V2.csproj --configuration Debug
      
      - name: Check for differences
        id: check_diff
        run: |
          # Check if there are any differences in the openapi directory
          if git diff --quiet openapi/; then
            echo "specs_changed=false" >> $GITHUB_OUTPUT
            echo "‚úÖ OpenAPI specs are already up to date"
          else
            echo "specs_changed=true" >> $GITHUB_OUTPUT
            echo "üìù OpenAPI specs have changes"
          fi
      
      - name: Create Pull Request
        if: steps.check_diff.outputs.specs_changed == 'true'
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'chore: update OpenAPI specification files'
          title: 'chore: update OpenAPI specification files'
          body: |
            ## OpenAPI Specs Update
            
            This PR updates the OpenAPI specification files to reflect the latest API changes.
            
            ### Changes
            The following OpenAPI spec files have been regenerated:
            - `openapi/openapi-v1.json`
            - `openapi/openapi-v1.1.json`
            - `openapi/openapi-v2.json`
            
            ### How to Review
            1. Review the diff to ensure the changes are expected
            2. Check that no breaking changes have been introduced unintentionally
            3. Verify that the specs are valid OpenAPI 3.0 documents
            
            ### Generated By
            This PR was automatically generated by the `Update OpenAPI Specs` workflow.
          branch: automated/update-openapi-specs
          delete-branch: true
          labels: |
            automated
            openapi
            documentation
      
      - name: Summary
        run: |
          if [ "${{ steps.check_diff.outputs.specs_changed }}" == "true" ]; then
            echo "‚úÖ Pull request created with updated OpenAPI specs"
          else
            echo "‚úÖ OpenAPI specs are already up to date - no action needed"
          fi
